# Таблица угрозы снижения рыночной цены инструмента из-за дивидендов #

По известному рыночному закону в момент отсечки на получение дивидендов инструмент классического рынка 
обычно теряет в рыночной цене на величину дивидендов.
На рынке РФ такое падение усугубляется дополнительно налоговым законодательством, 
призванным предотвратить слишком долгое держание бумаг владельцами.
В этом примере наш плагин будет скачивать из Интернета данный по датам отсечки
на дивиденды и ожидаемой дивидендной доходности и на их
основе строить таблицу "угрозы" падения цена. 
Ячейки таблицы будут подсвечиваться красным цветом пропорционально степени "угрозы": 
чем ближе к сегодняшнему
дню дата отсечки и чем выше потенциальная дивидендная доходность, тем выше считается угроза.

 ![Таблица угрозы снижения цены из-за дивидендов](doc/table_screenshot.png)
 
## Цель примера и приобретаемые навыки ##
 * Работа с отображением таблиц Quik через [QluaCpp](https://github.com/elelel/qluacpp.git)
 * Интеграция со сторонним источником данных

## Архитекутра проекта ##

Наш плагин должен получать данные из источника в Интернете, преобразовывать их в удобный для нас вид,
отстраивать таблицу, показывать ее и сразу завершать работу.
В маркетинговых целях многие интернет-сайты имеют дивидендные календари с интересующей нас
информации. Для целей этого примера был выбран дивидендный календарь SmartLab.ru как
соответствующий двум критериям: информацию в соотвтетствии с robots.txt разрешается получать
автоматически, и сайт отдает информацию без SSL, что упрощает ее получение.
Наши данные будут храниться в объекте класса [calendar](src/calendar.hpp), который будет отвечать
за получение и преобразование данных (простой ETL). Для хранения информации по каждому инструменту будет использоваться
класс calendar_record, задачей которого будет хранить информацию о тикере, дате отсечки, ожидаемой дивидендной доходности,
а также функции для вычисления дат.
Отображение данных в торговом терминале осуществлено в классе [dividends_table](src/dividens_table.hpp).

### Получение данных ###

Скачивание информации классом [calendar](src/calendar.cpp) производится при помощи libcurl, которая включена git-подмодулем
данного репозитария. Следует обратить внимание, что сейчас подмодуль ссылается на отредактированную версию
libcurl, т.к. официальная libcurl имеет ошибку, препятствующую сборке через CMake на Windows.
Поэтому, до того, как мэйнтейнеры libcurl примут PR, использование официального libcurl описанным в примере
образом невозможно. Метод *download* класса *calendar*, вызываемый из колбека *main*, скачивает при помощи libcurl вебстраницу
с информацией по дивидендам, после чего преобразовывает данные.

### Преобразование данных ###

Преобразование данных из HTML будет осуществляться для простоты "ручным" поиском строк и регулярными
выражениями. В более серьезной архитектуре может применен XML-парсер и др., такой вариант
оставляется читателю в качестве упражнения (внимание, SmartLab.ru имеет ошибки со вложенностью/закрытием тегов!).
Метод *download* вызывает вызывает *extract_dividends_block*, который извлекает весь HTML-блок с данными по дивидендами с
HTML-страницы. Метод *extract_record* делит этот блок на фрагменты по каждому инструменту, из которых извлекаются данные
типа calendar_record, в случае, если информация полна.

### Отображение данных ###
Отображение данных будет происходить в таблице терминала Quik, которая отстраивается при помощи интерфейса qluacpp
к соответствующим lua-функциям. Интерфейс к этой части программного кода находится в [dividends_table.hpp](src/dividends_table.hpp). Краткое описание класса *dividends_table* :

 * Конструктор класса сохраняет ссылку на calendar и инициализирует переменные с максимальными и минимальными
   показаниями данных, которые потом будут использованы для вычисления интенсивности красного цвета фона
 * create_table создает таблицу Quik (AllocTable) и ее колонки (AddColumn)
 * create_window создает окно (CreateWindow), назначает ему заголовок (SetWindowCaption), и добавляет каждую запись из ссылки на calendar при помощи фукнции create_row
 * Функции get_ticker_color, get_days_left_color, get_div_ret_color возвращают цвет фона ячейки, в зависимости от
   того, в каком месте на шкале минимальных/максимальных значений находится соответствующий
   показатель запрашиваемой записи
 * create_row добавляет ряд в таблицу, назначая данные каждой ячейки при помощи SetCell, и меняет фон на цвет,
   вычисленной функциями get_..._color
 * show показывет окно, сформировав таблицу, для чего вызывает create_table

## Тесты и TDD ##

Для повышения скорости разработки плагина использовались методы TDD. Эти методы особенно актуальны при разработке плагинов под чужие закрытые среды, где отладка осложнена. Для этого использовалась библиотека Catch,
с применением которой в последствии писались тесты корректности структур данных и парсинга html.
Тесты находятся в файле [dividend_threat_test.cpp](test/dividend_threat_test.cpp).
