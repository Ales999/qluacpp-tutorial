# Получение информации и отрисовка свечей графика из кеша Quik #
Плагин получает информацию о свечах по коллбеку и затем отрисовывает их в собственном окне по собственным правилам.

![Draw candles realtime screencast](doc/screencast.gif)

## Цель примера и приобретаемые навыки ##
 * Работа с получением данных графиков Quik в режиме реального времени при помощи функций CreateDataSource, SetUpdateCallback
 * Отображение собственного окна внутри Quik с отрисовкой изображения
 * Синхронизация потоков
 
## Архитектура ##

Проект состоит из трех логических частей: 
 * основного кода плагина - исходный файл [draw_candles_rt.cpp](src/draw_candles_rt.cpp)
 и его [заголовок](src/draw_candles_rt.hpp)
 * кода, ответственного за получение и хранение данных о свечах - 
 исходный файл [model.cpp](src/model.cpp) и его [заголовок](src/model.hpp)
 * код, отображающий свечи в окне - исходный файл [gui.cpp](src/gui.cpp) и его [заголовок](src/gui.hpp)
 
В основном коде создается базовый код плагина qlua. Создаются три функции Lua:
 * main - callback-обработчик с основным циклом плагина
 * OnStop - callback-обработчик, вызываемый при завершении работы плагина, используется
 для закрытия окна со свечами плагина
 * qluacpp_candles_cb - callback-обработчик для функции SetUpdateCallback, который будет
 вызываться каждый раз, когда терминалом получена новая информация о свече графика Quik
 
Код в файле [model.hpp](src/model.hpp) в структуре model объявляет подструктуру candle. В структуре
model будет содержаться вектор из элементов candle, который будет хранить информацию о последних
свечах нашего собственного графика. Структура model при инициализации создает DataSource (источник данных) Qlua
и хранит указатель на него. Так же в ней имеются std::mutex/srd::conditional_variable для синхронизации
с потоком отрисовки нашего окна с графиком. По мере поступления новых данных функция qluacpp_candles_cb
основоного кода будет уведомлять объект класса model об изменившихся свечах при помощи метода update. Чтобы
уведомить окно с графиком, о том, что данные изменились и нужно перерисовать окно, в структуре model
предусмотрена регистрация обратного вызова on_new_data. Обработчик этого метода назначается из [gui.cpp](src/gui.cpp).

Файлы GUI содержат singleton класс окна, и C-функции для стандартной работы с окнами WinApi (создание, обработчик событий и т.п.). Чтобы события, предназначенные нашему окну не "съедались" родным обработчиком Quik, окно создается в отдельном
потоке. Синхронизация с данными, которые находятся в model и меняются не в потоке отображения GUI, происходит при
помощи методов notify() и wait() структуры model. Отрисовка свечей происходит при помощи обычных функций для растровой
графики WinApi.




 
