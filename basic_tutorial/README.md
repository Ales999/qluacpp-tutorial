# Базовый пример #

В этом примере будет дана пошаговая инструкция по подготовке рабочей среды для создания плагина Quik при помощи библиотеки qluacpp.
Создаваемый плагин будет обладать простейшим функционалом: в первые пять секунд после запуска скрипта каждую секунду выводить сообщение при помощи стандартной функции message терминала Quik, после чего завершит работу.

![Tick message screenshot](doc/message_screenshot.png)

Приглагаемый код плагина можно скомпилировать примерно следующим образом из Developer Command Prompt (32-битного) от MSVS:
```
git clone --recurse-submodules https://github.com/elelel/qluacpp-tutorial.git c:\source\basic_tutorial
mkdir c:\build\basic_tutorial_basic
cd c:\build\basic_tutorial_basic
cmake -G "NMake Makefiles" -DQLUACPP_LUA_INCLUDE=c:\lib\lua\include -DQLUACPP_LUA_LIBRARY=c:\lib\lua\lua51.lib c:\source\basic_tutorial\basic
nmake
```

Более подробно инструкции даны в тексте этого документа.

## Цель примера и приобретаемые навыки ##
 * Создание с нуля "пустого" проекта QluaCpp
 * Использование простейшей функции message Qlua

## Используемые программы ##

Для написания и запуска плагина понадобится ряд программ.

### Терминал Quik ###

Торговый терминал Quik понадобится только для запуска плагина, написание кода и сборка возможна без него

### Git ###

Система контроля версий git понадобится для скачивания библиотек и их зависимостей.
Установка другим способом находящихся под git библиотек данного проекта не рекомендуется, поскольку в их
структуре используются подмодули, обеспечивая соответствие версий зависимостей.

### CMake ###

Библиотека qluacpp в данный момент является статически компилируемой библиотекой. Хотя в дальнейшем вероятен перевод в
header-only, сейчас необходима компиляция в отдельный трансляционный юнит. Поэтому использование CMake, при помощи
которого собирается сама библиотека, обязателен как минимум для сборки самой библиотеки. Для удобства и сам пример
будет разрабатываться с использованием CMake.

### Компилятор ###

Для сборки этого примера потребуется NMake, входящий в состав Microsoft Visual Studio или Windows Development Tools.
Сама IDE не потребуется, хотя будет показано, как сгенерировать проект Visual Studio из CMake. В примере
использовалась Visual Studio 2017

### Текстовый редактор ###

Для написания кода и других файлов примера используется только текстовый редактор, что делает разработку независимой от
среды. Можно использовать любой текстовый редактор: от Visual Studio, Notepad и т.п. При создании этого примера использовался Emacs.

## Начальная структура проекта ##

На файловой системе проект плагина будет выглядеть следующим образом

[../contrib](../contrib) - директория для сторонних библиотек, в том числе qluacpp.
Обратите внимание, чтоб эта директория находится в корневой директории примеров (на один уровень выше директории этого примера).

[src](src) - исходные файлы нашего плагина

Создаем указанные выше директории, после чего помещаем наш проект под систему контроля версий git.
Если используется совместимый со стандартным git, для этого открываем Command Prompt от Windows, заходим в директорию проекта и выполняем:

```git init```

В дальнейшем подразумевается, что читатель будет по мере необходимости самостоятельно делать ```git commit```

## Установка сторонних библиотек ##

### qluacpp ###

В директории contrib проекта для установки qluacpp исполняем команду:

```git submodule add https://github.com/elelel/qluacpp.git```

Для обновления зависимостей подмодуля исполняем:

```git submodule update --init --recursive```

### Установка lua ###

#### Скачивание нужной версии библиотеки ####

Скачиваем наиболее близкую по major версии к версии модифицированной Lua, включенной в Quik, оригинальную библиотеку Lua на Sourceforge официальном сайте. На момент написания данного документа Quik использует версию Lua 5.1, которая является довольно старой. Так как интерфейс библиотеки меняется редко, а также делая оптимистичное предположение, что разработчики Arqa включили все оригинальные изменения в этой ветви, поскольку последний был очень давно, будем считать, что их код наиболее близок к самой последней оригинальной библиотеке в рамках ветви 5.1. Для этого идем на страницу скачивания библиотеки на Sourceforge: [https://sourceforge.net/projects/luabinaries/files/]()

На момент написания данного документа максимальной версией в рамках ветви 5.1 является версия 5.1.5. Переходим в этот каталог, где далее выбираем **Windows Libraries** и **Dynamic**.

Выбираем архив, ближайщий к нашему сценарию использования: Win32, dll, 14 = **lua-5.1.5_Win32_dll14_lib.zip**

В директории [contrib](../contrib) создаем директорию *lua*. Копируем туда содержимое скаченного оригинального архива с библиотекой Lua.

## Создание CMake проекта ##

В директории проекта созаем файл [CMakeLists.txt](CMakeLists.txt)

В начале файла указываем:

```cmake
cmake_minimum_required(VERSION 3.4.0)
project(basic_tutorial)
```

Создаем переменные с путями к используемым в проекте библиотекам и их зависимостям:

```cmake
get_filename_component(TOP_DIR "${CMAKE_CURRENT_SOURCE_DIR}" PATH)
set(QLUACPP "${TOP_DIR}/contrib/qluacpp")
set(LUACPP "${TOP_DIR}/contrib/qluacpp/contrib/luacpp")
set(LUA "${TOP_DIR}/contrib/lua")
```

Для библиотеки qluacpp необходимо указать пути к файлам библиотеки lua.
Для lib-файла делаем это через переменную QLUACPP_LUA_LIBRARY, настроив ее на путь к скаченному lib-файлу библиотеки Lua:

```cmake
set(QLUACPP_LUA_LIBRARY "${LUA}/lua5.1.lib")
```

Указываем путь к загаловкам скаченной библиотеки Lua:

```cmake
set(QLUACPP_LUA_INCLUDE_DIR "${LUA}/include")
```

Перечисляем директории, которые должны быть доступны для директивы #include препроцессора. Они включают и include-директории зависимостей используемых проектом библиотек.

```cmake
include_directories(
  ${QLUACPP}/include
  ${LUACPP}/include
  ${QLUACPP_LUA_INCLUDE_DIR}
)
```

Подключаем компиляцию библиотеки qluacpp:
```cmake
if (NOT TARGET qluacpp)
  add_subdirectory(${QLUACPP} qluacpp)
endif()
```

Перечисляем исходные файлы нашего плагина:

```cmake
set(SOURCES
  src/basic_tutorial.cpp
)
```

Указываем, что мы хотим создать DLL:

```cmake
add_library(lualib_basic_tutorial SHARED ${SOURCES})
```

Указываем конфигурацию линковки:

```cmake
target_link_libraries(lualib_basic_tutorial qluacpp)
```

## Пишем код плагина ##

### Создание едиственного исходного файла примера ###

Создаем файл [basic_tutorial.cpp](src/qlua_tutorial.cpp) в директории [src](src) и открываем его в редакторе.

Декларируем через директивы препроцессора, что мы создаем "библиотеку" Lua:

```c++
#define LUA_LIB
#if defined(WIN32) || defined(_WIN32) || defined(__WIN32)
  #define LUA_BUILD_AS_DLL
#endif
```

После этого подключаем библиотеку qluacpp:

```c++
#include <qlua>
```

Создаем глобальную структуру для интерфейса наших "библиотечных" функций для Lua:

```c++
static struct luaL_reg ls_lib[] = {
  { NULL, NULL }
};
```

Создаем функцию с C ABI, которая будет инициализировать "библиотеку":

```c++
extern "C" {
  LUALIB_API int luaopen_lualib_basic_tutorial(lua_State *L) {
    // Here will be code...
    return 0;
  }
}
```

В функции *luaopen_lualib_basic_tutorial* создаем объект интерфейса Lua с C++:

```c++
    lua::state l(L);
```

...и объект интерфейса Quik Lua:

```c++
    qlua::extended_api q(l);
```

Библиотека qluacpp предлагает два объекта API для взаимодействия с Quik Lua: **api** и **extended_api**. Объект api является максимально близким к родному интерфейсу QLUA от Arqa, вплоть до повторения опечаток в названиях API функций, несоответствий и проч. Объект extended_api является надмножеством относительно объекта api, содержа также дополнительные функции для удобства программирования в C++, консистеность терминологии и др.

Подключаем наш callback-обработчик для функции main qlua-скрипта:
```c++
q.set_callback<qlua::callback::main>(my_main);
```

Наконец, подключаем нашу "библиотеку" к Lua:

```c++
luaL_openlib(L, "lualib_basic_tutorial", ls_lib, 0);
```

## Сборка проекта ##

В любом удобном месте, не внутри директории с репозитарием проекта, мы должны создать директории, в которые будет сгенерирован при помощи CMake проект под нужную нам среду.

В меню Start Windows ищем Command Prompt for VS2017. При выборе следует помнить, что мы компилируем 32-битный проект. Поэтому, если компиляция происходит на 64-битном Windows, следует выбирать x64_x86 Cross Tools Command Prompt.



### Компиляция проекта при помощи NMake ###

NMake - мейкер от Microsoft, который поставляется в составе Visual Studio, Windows Developer Tools и др.

Создаем директорию *basic_tutorial_nmake*

Заходим в нее и выполняем:
```
"c:\Program Files\CMake\bin\cmake.exe" -G "NMake Makefiles" c:\path\basic_tutorial\code
```
где последний аругмент - путь к коду проекта, а опция -G указывает, под какую среду генерировать проект.

Далее запускаем:

```
NMake
```
В результате будет скомпилирован файл DLL нашего плагина, который можно использовать как Lua "библиотеку" в Quik.


### Проект (solution)  IDE Visual Studio ###

Cоздаем директорию *basic_tutorial_vs*. Заходим в нее и выполняем:
```
"c:\Program Files\CMake\bin\cmake.exe" -G "Visual Studio 15 2017" c:\path\basic_tutorial\code
```
где последний аругмент - путь к коду проекта, а опция -G указывает, под какую среду генерировать проект.

После этого в указанной директории будет создан проект Visual Studio нашего плагина. Описание дальнейшей работы с Visual Studio не является предметом данного документа.



## Установка плагина в терминал Quik ##

В директории терминала **Quik** создаем копию файла lua51.dll от Arqa (прокси-библиотеки с интерфейсом Lua) и называем ее lua5.1.dll, для соответствия идентификаторам, используемым в родном lua5.1.lib, файла из состава архива Lua, который мы скачивали на этапе установки библиотек.

Копируем скомпилированный файл плагина **lualib_basic_tutorial.dll** в директорию **Quik**.

Создаем в директории **Quik** lua-скрипт **basic_tutorial.lua**, грузящий нашу "библиотеку Lua" и содержащий единственную строку:

```lua
require "lualib_basic_tutorial"
```

Для запуска плагина в терминале **Quik** (info.exe) добавляем и запускаем Lua-скрипт basic_tutorial.lua

