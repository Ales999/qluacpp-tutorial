# Протоколирование обезличенных сделок (alltrade) #

Плагин сохраняет информацию из сделок, полученных по коллбеку **OnAllTrade** в текстовой файл.


## Цель примера и приобретаемые навыки ##
 * Демонстрация использования коллбека OnAllTrade для получения обезличенных сделок
 * Демонстрация простой технику написания многопоточного функционала в плагине Quik

## Описание работы ##

Плагин сохраняет некоторые поля из данных о произошедших сделках: номер сделки, код инструмента, количество, объем -
полученных по коллбеку OnAllTrade (подробнее об этих данных см. *qlua.chm*). Данные сохраняются в файл *all_trade_log.txt*
текущей директории (директория, откуда запускался info.exe). В документации QLUA делается предупреждения, что
функции обратного вызова происходят на основном потоке терминала, поэтому не следует блокировать исполнение надолго.
Традиционно в таком случае используется отдельный поток обработки данных, что влечет за собой использования того или иного
механизма синхронизации. Как правило, применяется тот или иной вид локинга (мьютексы и проч.). Однако программирование плагина
с локингом для Quik - не самое приятное занятие: логика родного локинга терминала не документирована, а структура с main-потоком плагина и коллбеками на основном потоке терминала усложняет задачу. В этом примере
демонстрируется другой подход: использование lock-free двухпоточной структуры данных (reader writer queue).
Обработчик коллбека OnAllTrade сохраняет данные на очереди, в то время как отдельный поток сохраняет информацию каждую минуту.
Итоговый файл содержит записи, где первые два поля, предшествующие данным из торговой системы - время
получения информации и время сохранения информации.

Перед запуском скрипта следует предварительно открыть таблицу обезличенных сделок для заказа данных ("Создать окно"/"Таблица обезличенных сделок").

Пример файла с итоговыми данными:
```
Event time	Time written	SecCode	Price	Value	Qty
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.02	6151	5
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	495730	403
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	1230.1	1
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	3690.3	3
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	6150.5	5
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	4920.4	4
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	30752.5	25
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	1230.1	1
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	49204	40
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	246020	200
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123.01	139001	113
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123	3690	3
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	ALRS	88.11	8811	1
Tue Apr 18 03:35:46 2017	Tue Apr 18 03:35:46 2017	GAZP	123	67650	55
...
Tue Apr 18 03:36:47 2017	Tue Apr 18 03:37:47 2017	UNAC	0.7245	7245	1
Tue Apr 18 03:36:47 2017	Tue Apr 18 03:37:47 2017	TATN	324.65	3246.5	1
Tue Apr 18 03:36:47 2017	Tue Apr 18 03:37:47 2017	SBER	153.12	4593.6	3
Tue Apr 18 03:36:47 2017	Tue Apr 18 03:37:47 2017	SBER	153.13	1531.3	1
...
Tue Apr 18 03:36:47 2017	Tue Apr 18 03:37:47 2017	SBER	153.08	153080	100
Tue Apr 18 03:36:47 2017	Tue Apr 18 03:37:47 2017	SBER	153.08	378108	247
Tue Apr 18 03:36:48 2017	Tue Apr 18 03:37:47 2017	ALRS	88.06	8806	1
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	KUZB	0.0146	146	1
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	KUZB	0.0146	146	1
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	KUZB	0.0146	146	1
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	PRFN	5.19	5190	1
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	SBERP	113.26	11326	1
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	YNDX	1336.5	2673	2
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	NMTP	6.965	6965	1
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	NMTP	6.965	34825	5
Tue Apr 18 03:36:49 2017	Tue Apr 18 03:37:47 2017	NMTP	6.965	6965	1
Tue Apr 18 03:36:50 2017	Tue Apr 18 03:37:47 2017	SBER	153.12	4593.6	3
Tue Apr 18 03:36:50 2017	Tue Apr 18 03:37:47 2017	SBER	153.13	4593.9	3
Tue Apr 18 03:36:50 2017	Tue Apr 18 03:37:47 2017	SBER	153.14	16845.4	11
Tue Apr 18 03:36:50 2017	Tue Apr 18 03:37:47 2017	SBER	153.14	1531.4	1

```

Как видно, первый столбец содержит время события, а второй - время записи события в файл, которое меняется ровно каждую минуту.
