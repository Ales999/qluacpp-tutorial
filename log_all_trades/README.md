# Протоколирование обезличенных сделок (alltrade) #

Плагин сохраняет информацию из сделок, полученных по коллбеку **OnAllTrade** в текстовой файл.


## Цель примера и приобретаемые навыки ##
 * Использование коллбека OnAllTrade для получения обезличенных сделок
 * Использование API QLua, требующих обработки результата в lambda-функции
 * Получение нужных полей таблиц напрямую из структур Lua
 * Демонстрация простой технику написания многопоточного функционала в плагине Quik

## Описание работы ##

Плагин сохраняет в log-файл информацию о классах, доступных терминалу в текущей сессии, после чего сохраняет некоторые поля из данных о произошедших сделках: номер сделки, код инструмента, количество, объем -
полученных по коллбеку OnAllTrade (подробнее об этих данных см. *qlua.chm*). Данные сохраняются в файл *all_trade_log.txt*
текущей директории (директория, откуда запускался info.exe). В документации QLUA делается предупреждения, что
функции обратного вызова происходят на основном потоке терминала, поэтому не следует блокировать исполнение надолго.
Традиционно в таком случае используется отдельный поток обработки данных, что влечет за собой использования того или иного
механизма синхронизации. Как правило, применяется тот или иной вид локинга (мьютексы и проч.). Однако программирование плагина
с локингом для Quik - не самое приятное занятие: логика родного локинга терминала не документирована, а структура с main-потоком плагина и коллбеками на основном потоке терминала усложняет задачу. В этом примере
демонстрируется другой подход: использование lock-free двухпоточной структуры данных (reader writer queue).
Обработчик коллбека OnAllTrade сохраняет данные на очереди, в то время как отдельный поток сохраняет информацию каждую минуту.
Итоговый файл содержит записи, где первые два поля, предшествующие данным из торговой системы - время
получения информации и время сохранения информации.

Перед запуском скрипта следует предварительно открыть таблицу обезличенных сделок для заказа данных ("Создать окно"/"Таблица обезличенных сделок").

Пример файла с итоговыми данными:
```

```

Как видно, время записи получения события и время его сохранения отличаются: события записываются в файл один раз в минуту.
